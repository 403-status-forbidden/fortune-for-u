# 포팅 매뉴얼 상세

## 환경 상세

### 형상 관리

- GitLab

### 이슈 관리

- Jira

### 커뮤니케이션

- Mattermost
- Notion

### IDE

- Intellij CE 2023.1.3
- Visual Studio Code
  - vim

### Server

- AWS EC2 t5.large
  - Ubuntu 20.04
  - Docker 24.0.5

### Frontend

- Vue3
  - Pinia 2.1.6
- node.js 18.16.1
- openvidu-browser 2.28.0

### Backend

- Java OpenJDK zulu-11
- SpringBoot 2.7.13
  - Gradle 8.1.1
  - Spring Data JPA
  - Spring Security
  - Spring Amqp
  - Lombok
  - Querydsl
  - Swagger
- OpenVidu Server 2.28.0
- Kurento Media Server 7.0.1

### Database

- MariaDB (on AWS RDS)

### Infra

- Jenkins 2.401.2
- docker-compose 1.25.0

## 프로젝트 구조

![그림2.png](../README/build2.png)

## SSH 연결 방법

```bash
ssh -i key_name.key ubuntu@ip
ex> ssh -i i9A403T.pem ubuntu@ipa403.p.ssafy.io
```

## Docker 설치

```bash
# apt 업데이트
sudo apt-get update

# 필수 요소 설치
sudo apt-get install \
    apt-transport-https \
    ca-certificates \
    curl \
    gnupg-agent \
    software-properties-common

# docker gpg 키 설치
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
OK

# docker 레포지토리 추가
sudo add-apt-repository \
   "deb [arch=amd64] https://download.docker.com/linux/ubuntu \
   $(lsb_release -cs) \
   stable"

# apt 업데이트
sudo apt-get update

# docker 설치
sudo apt-get install docker-ce docker-ce-cli containerd.io

# docker 실행 권한 추가
sudo usermod -aG docker ubuntu

# docker-compose 설치
sudo curl -L https://github.com/docker/compose/releases/download/v1.25.0/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose

# docker-compose 실행권한 추가
sudo chmod +x /usr/local/bin/docker-compose
```

## 젠킨스 설치

```bash
sudo apt-get install jenkins

# 설치 이후 안내되는 내용대로 환경 설정을 진행하면 된다.
```

## 젠킨스 플러그인 설치

- Git, GitLab, Docker, SSH, Gradle, NodeJS 관련 플러그인을 설치해주면 된다.

## 젠킨스 프로젝트 설정

- Git의 경우 아래와 같이 token으로 접근하는 url을 입력해주면 된다.
  ![Untitled](../README/build2.png)
- push 혹은 merge 이벤트 발생시 자동으로 빌드를 진행하기 위해서는 아래와 같이 설정한다.
  ![Untitled](../README/build3.png)

```bash
# 빌드 스크립트는 아래의 것을 사용한다

docker image prune -f
docker-compose build --parallel
docker-compose up -d
```

## https 주의 사항

https를 적용하기 위해서는 certbot을 설치해야한다.
```bash
#snapd를 설치해준다
sudo snap install core

#기존의 잘못된 certbot 삭제
sudo apt remove certbot

#certbot 설치
sudo snap install --classic certbot

#인증서 받아오기
sudo certbot --nginx

#포트 열어주기
ufw allow ssh
ufw allow 80/tcp
ufw allow 443/tcp
ufw enable => yes
```
## 이미지 빌드 방법

### Frontend

```bash
# 프론트엔드 빌드만 별도로 수행하기 위해서는 아래와 같이 입력한다

docker build -t gogobattle/firstdocker:front
docker push gogobattle/firstdocker:front
```

### Backend(WebServer)

```bash
# 백엔드 빌드만 별도로 수행하기 위해서는 아래와 같이 입력한다

docker build -t gogobattle/firstdocker:back
docker push gogobattle/firstdocker:back
```

### Backend(RTCServer)

```bash
# OpenVidu 서버 빌드만 별도로 수행하기 위해서는 아래와 같이 입력한다

docker-compose up -d
```

단, docker-compose를 실행하기 위해서는 docker-compose.yml 파일이 필요합니다. docker-compose.yml의 내용은 다음과 같습니다.


```bash
version: '3.1'

services:

    openvidu-server:
        image: openvidu/openvidu-server:2.28.0
        restart: on-failure
        network_mode: host
        entrypoint: ['/usr/local/bin/entrypoint.sh']
        volumes:
            - ./coturn:/run/secrets/coturn
            - /var/run/docker.sock:/var/run/docker.sock
            - ${OPENVIDU_RECORDING_PATH}:${OPENVIDU_RECORDING_PATH}
            - ${OPENVIDU_RECORDING_CUSTOM_LAYOUT}:${OPENVIDU_RECORDING_CUSTOM_LAYOUT}
            - ${OPENVIDU_CDR_PATH}:${OPENVIDU_CDR_PATH}
        env_file:
            - .env
        environment:
            - SERVER_SSL_ENABLED=false
            - SERVER_PORT=5443
            - KMS_URIS=["ws://localhost:8888/kurento"]
            - COTURN_IP=${COTURN_IP:-auto-ipv4}
            - COTURN_PORT=${COTURN_PORT:-3478}
        logging:
            options:
                max-size: "${DOCKER_LOGS_MAX_SIZE:-100M}"

    kms:
        image: ${KMS_IMAGE:-kurento/kurento-media-server:7.0.1}
        restart: always
        network_mode: host
        ulimits:
          core: -1
        volumes:
            - /opt/openvidu/kms-crashes:/opt/openvidu/kms-crashes
            - ${OPENVIDU_RECORDING_PATH}:${OPENVIDU_RECORDING_PATH}
            - /opt/openvidu/kurento-logs:/opt/openvidu/kurento-logs
        environment:
            - KMS_MIN_PORT=40000
            - KMS_MAX_PORT=57000
            - GST_DEBUG=${KMS_DOCKER_ENV_GST_DEBUG:-}
            - KURENTO_LOG_FILE_SIZE=${KMS_DOCKER_ENV_KURENTO_LOG_FILE_SIZE:-100}
            - KURENTO_LOGS_PATH=/opt/openvidu/kurento-logs
        logging:
            options:
                max-size: "${DOCKER_LOGS_MAX_SIZE:-100M}"
 coturn:
        image: openvidu/openvidu-coturn:2.28.0
        restart: on-failure
        ports:
            - "${COTURN_PORT:-3478}:${COTURN_PORT:-3478}/tcp"
            - "${COTURN_PORT:-3478}:${COTURN_PORT:-3478}/udp"
        env_file:
            - .env
        volumes:
            - ./coturn:/run/secrets/coturn
        command:
            - --log-file=stdout
            - --listening-port=${COTURN_PORT:-3478}
            - --fingerprint
            - --min-port=${COTURN_MIN_PORT:-57001}
            - --max-port=${COTURN_MAX_PORT:-65535}
            - --realm=openvidu
            - --verbose
            - --use-auth-secret
            - --static-auth-secret=$${COTURN_SHARED_SECRET_KEY}
        logging:
            options:
                max-size: "${DOCKER_LOGS_MAX_SIZE:-100M}"
nginx:
        image: openvidu/openvidu-proxy:2.28.0
        restart: always
        network_mode: host
        volumes:
            - ./certificates:/etc/letsencrypt
            - ./owncert:/owncert
            - ./custom-nginx-vhosts:/etc/nginx/vhost.d/
            - ./custom-nginx-locations:/custom-nginx-locations
            - ${OPENVIDU_RECORDING_CUSTOM_LAYOUT}:/opt/openvidu/custom-layout
        environment:
            - DOMAIN_OR_PUBLIC_IP=${DOMAIN_OR_PUBLIC_IP}
            - CERTIFICATE_TYPE=${CERTIFICATE_TYPE}
            - LETSENCRYPT_EMAIL=${LETSENCRYPT_EMAIL}
            - PROXY_HTTP_PORT=${HTTP_PORT:-}
            - PROXY_HTTPS_PORT=${HTTPS_PORT:-}
            - PROXY_HTTPS_PROTOCOLS=${HTTPS_PROTOCOLS:-}
            - PROXY_HTTPS_CIPHERS=${HTTPS_CIPHERS:-}
            - PROXY_HTTPS_HSTS=${HTTPS_HSTS:-}
            - ALLOWED_ACCESS_TO_DASHBOARD=${ALLOWED_ACCESS_TO_DASHBOARD:-}
            - ALLOWED_ACCESS_TO_RESTAPI=${ALLOWED_ACCESS_TO_RESTAPI:-}
            - PROXY_MODE=CE
            - WITH_APP=true
            - SUPPORT_DEPRECATED_API=${SUPPORT_DEPRECATED_API:-false}
            - REDIRECT_WWW=${REDIRECT_WWW:-false}
            - WORKER_CONNECTIONS=${WORKER_CONNECTIONS:-10240}
            - PUBLIC_IP=${PROXY_PUBLIC_IP:-auto-ipv4}
        logging:
            options:
                max-size: "${DOCKER_LOGS_MAX_SIZE:-100M}"
```


### Backend(RabbitMq Server)

```bash
# RabbitMq 서버 빌드만 별도로 수행하기 위해서는 아래와 같이 입력한다

docker build -t gogobattle/firstdocker:back
docker push gogobattle/firstdocker:back
```

### Backend(Vito(STT) Server)

```bash
# Vito 서버 빌드만 별도로 수행하기 위해서는 아래와 같이 입력한다

docker build -t gogobattle/firstdocker:vito
docker push gogobattle/firstdocker:vito
```

### Backend(ChatGPT Server)

```bash
# ChatGPT 서버 빌드만 별도로 수행하기 위해서는 아래와 같이 입력한다

docker build -t gogobattle/firstdocker:gpt
docker push gogobattle/firstdocker:gpt
```

## 사용 포트 목록

- 80, 443 : http
- 8080 : Frontend
- 3478, 5349 : OpenVidu coturn
- 5000 : Backend
- 5672 : RabbitMq
- 5678 : Vito 
- 5679 : ChatGpt
- 15672 : RabbitMq 관리
- 8443 : OpenVidu Wrapping API 서버

## MySQL ERD

![erd.png](./README/erd.png)
